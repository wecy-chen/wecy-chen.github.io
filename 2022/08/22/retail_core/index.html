<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>新零售项目杂记 | 欢迎,欢迎━(*｀∀´*)ノ亻!</title><meta name="keywords" content="代码片段"><meta name="author" content="wecyChen"><meta name="copyright" content="wecyChen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="新零售代码片段">
<meta property="og:type" content="article">
<meta property="og:title" content="新零售项目杂记">
<meta property="og:url" content="https://wecy-chen.github.io/2022/08/22/retail_core/index.html">
<meta property="og:site_name" content="欢迎,欢迎━(*｀∀´*)ノ亻!">
<meta property="og:description" content="新零售代码片段">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wecy-chen.github.io/xxx">
<meta property="article:published_time" content="2022-08-22T01:42:38.307Z">
<meta property="article:modified_time" content="2023-06-10T02:12:05.327Z">
<meta property="article:author" content="wecyChen">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wecy-chen.github.io/xxx"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://wecy-chen.github.io/2022/08/22/retail_core/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '新零售项目杂记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-10 10:12:05'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="欢迎,欢迎━(*｀∀´*)ノ亻!" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/27757669?s=400&amp;u=26d5a9ed7384d80a460ddb7961c1bd28f40e3aae&amp;v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: xxx"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">欢迎,欢迎━(*｀∀´*)ノ亻!</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">新零售项目杂记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-22T01:42:38.307Z" title="发表于 2022-08-22 09:42:38">2022-08-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-10T02:12:05.327Z" title="更新于 2023-06-10 10:12:05">2023-06-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5/">代码片段</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="新零售项目杂记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>代码片段</p>
<h1 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h1><p><a target="_blank" rel="noopener" href="https://doc.sequoiadb.com/cn/sequoiadb-cat_id-1558957224-edition_id-500">mongodb 中文文档</a></p>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> MAPP.db_queryAll(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">condition</span>: &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>获取一条数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> commodity = <span class="keyword">await</span> MAPP.db_getOne(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&#x27;commodity&#x27;</span>,</span><br><span class="line">  <span class="attr">condition</span>: &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="string">&#x27;58805dd61d8bdc9c56cc3e2d&#x27;</span>,</span><br><span class="line">    <span class="attr">distributed</span>: &#123;</span><br><span class="line">      <span class="attr">$elemMatch</span>: &#123;</span><br><span class="line">        <span class="attr">store_id</span>: <span class="string">&#x27;5d64d9b75fc33f07bcfe1435&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">filters</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;distributed.$:&#x27;</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol>
<li>不分页</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> MAPP.db_queryAll(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&#x27;area&#x27;</span>,</span><br><span class="line">  <span class="attr">condition</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">pageTurn</span>: <span class="literal">false</span>, <span class="comment">//默认true</span></span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;noPage&#x27;</span>, <span class="comment">//默认&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">isCount</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">params</span>: &#123;</span><br><span class="line">    <span class="attr">page</span>: i + <span class="number">1</span>,</span><br><span class="line">    <span class="attr">limit</span>: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">options</span>: &#123;</span><br><span class="line">    <span class="attr">lean</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">filters</span>: &#123;</span><br><span class="line">    <span class="attr">adcode</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取过滤数组第一个元素</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  result = [], count = <span class="number">0</span></span><br><span class="line">&#125; = <span class="keyword">await</span> MAPP.db_queryAll(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&#x27;commodity&#x27;</span>,</span><br><span class="line">  <span class="attr">condition</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;distributed.store_id&#x27;</span>: <span class="string">&#x27;5d64d9b75fc33f07bcfe1435&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">filters</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;distributed.$&#x27;</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回</span></span><br><span class="line">[&#123;</span><br><span class="line">  <span class="attr">_id</span>: <span class="number">58805</span> dd61d8bdc9c56cc3e2d,</span><br><span class="line">  <span class="attr">distributed</span>: [</span><br><span class="line">    [<span class="built_in">Object</span>]</span><br><span class="line">  ]</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">$project</span>: &#123;</span><br><span class="line">   <span class="attr">medical</span>: <span class="number">1</span>, <span class="comment">// 医保商品</span></span><br><span class="line">  <span class="attr">epidemic_situation</span>: <span class="number">1</span>, <span class="comment">// 疫情商品</span></span><br><span class="line">  <span class="attr">name</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">bar_code</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">prescription</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">original_price</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">current_price</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">unit_num</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="comment">// distributed: 1,</span></span><br><span class="line">  <span class="attr">three_categories</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">cold_chain</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">overseas</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">hide_goods</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">filteredArray</span>: &#123;</span><br><span class="line">              <span class="string">&#x27;$filter&#x27;</span>: &#123;</span><br><span class="line">                <span class="attr">input</span>: <span class="string">&#x27;$distributed&#x27;</span>,</span><br><span class="line">                <span class="attr">as</span>: <span class="string">&#x27;item&#x27;</span>,</span><br><span class="line">                <span class="attr">cond</span>: &#123;</span><br><span class="line">                  <span class="string">&#x27;$and&#x27;</span>: [</span><br><span class="line">                    &#123; <span class="string">&#x27;$eq&#x27;</span>: [<span class="string">&#x27;$$item.store_id&#x27;</span>, ObjectId(<span class="string">&#x27;6201e7893d257513aa054e5c&#x27;</span>)] &#125;,</span><br><span class="line">                    &#123; <span class="string">&#x27;$eq&#x27;</span>: [<span class="string">&#x27;$$item.shelf&#x27;</span>, <span class="literal">true</span>] &#125;,</span><br><span class="line"><span class="comment">//                    &#123; &#x27;$gt&#x27;: [&#x27;$$item.stock&#x27;, 0] &#125;</span></span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; <span class="attr">$project</span>: &#123; <span class="attr">firstArrayElement</span>: &#123; <span class="attr">$arrayElemAt</span>: [<span class="string">&quot;$myArrayField&quot;</span>, <span class="number">0</span>] &#125; &#125; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">![jsuan.png](<span class="regexp">/image/</span>retail_core/xxxx.png)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>联表</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> MAPP.db_queryAll(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">params</span>: &#123;</span><br><span class="line">    page,</span><br><span class="line">    limit,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">isCount</span>: <span class="literal">false</span>, <span class="comment">//不返回条数</span></span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;populate&quot;</span>, <span class="comment">//设置连表</span></span><br><span class="line">  <span class="attr">populate</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&quot;user_id&quot;</span>, <span class="comment">//本表id字段</span></span><br><span class="line">      <span class="attr">select</span>: <span class="string">&quot;nickname full_name phone_number&quot;</span>, <span class="comment">//外表字段过滤</span></span><br><span class="line">      <span class="attr">model</span>: <span class="string">&quot;member&quot;</span>, <span class="comment">//外表</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&quot;cashier_id&quot;</span>,</span><br><span class="line">      <span class="attr">select</span>: <span class="string">&quot;staff_name&quot;</span>,</span><br><span class="line">      <span class="attr">model</span>: <span class="string">&quot;store_staff&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">sort</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">filters</span>: &#123;&#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>取模 <code>$mod</code></p>
<p>获取一条数据 <code>MAPP.db_getOne()</code></p>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> MAPP.db_setOne(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">condition</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="attr">$set</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>语法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">data: &#123;</span><br><span class="line">  <span class="comment">//更新数据</span></span><br><span class="line">  <span class="attr">$set</span>: &#123;&#125;,</span><br><span class="line">  <span class="comment">//插入数据,重复的不插入</span></span><br><span class="line">  <span class="attr">$addToSet</span>: &#123;&#125;</span><br><span class="line">  <span class="comment">//插入数据</span></span><br><span class="line">  <span class="attr">$push</span>: &#123;&#125;</span><br><span class="line">  <span class="comment">//更新或插入数据</span></span><br><span class="line">  <span class="attr">$setOnInsert</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>搜索并更新</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> MAPP.db_setOne(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&#x27;commodity&#x27;</span>,</span><br><span class="line">  <span class="attr">condition</span>: &#123; <span class="attr">_id</span>: product_id, <span class="string">&#x27;distributed.store_id&#x27;</span>: store_id &#125;,</span><br><span class="line">  <span class="attr">data</span>: &#123; <span class="attr">$inc</span>: &#123; <span class="string">&#x27;distributed.$.stock&#x27;</span>: stock &#125; &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>更新或插入数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> MAPP.db_setOne(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">condition</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="attr">$set</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">$setOnInsert</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">options</span>: &#123;</span><br><span class="line">    <span class="attr">lean</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">new</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">upsert</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">setDefaultsOnInsert</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// options 必须配置</span></span><br></pre></td></tr></table></figure>

<p>多次嵌套修改</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> MAPP.db_setOne(&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="string">&#x27;deliver_accept_order&#x27;</span>,</span><br><span class="line">        <span class="attr">condition</span>: &#123; <span class="attr">_id</span>: _id, <span class="attr">product_list</span>: &#123; <span class="attr">$elemMatch</span>: &#123; <span class="attr">batch_number</span>: &#123; <span class="attr">$elemMatch</span>: &#123; <span class="attr">_id</span>: batch_number_id &#125; &#125; &#125; &#125; &#125;,</span><br><span class="line">        <span class="attr">data</span>: &#123;</span><br><span class="line">          <span class="attr">$set</span>: &#123;</span><br><span class="line">            <span class="attr">receipt_status</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">&#x27;product_list.$[e].batch_number.$[val].in_quantity&#x27;</span>: in_quantity,</span><br><span class="line">            <span class="string">&#x27;product_list.$[e].batch_number.$[val].diff_quantity&#x27;</span>: transit_quantity - in_quantity,</span><br><span class="line">            <span class="string">&#x27;product_list.$[e].batch_number.$[val].low_quantity&#x27;</span>: low_quantity,</span><br><span class="line">            <span class="string">&#x27;product_list.$[e].batch_number.$[val].low_reason&#x27;</span>: low_reason,</span><br><span class="line">            <span class="string">&#x27;product_list.$[e].batch_number.$[val].take_status&#x27;</span>: in_quantity &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 更新多层嵌套数组</span></span><br><span class="line">        <span class="attr">options</span>: &#123;</span><br><span class="line">          <span class="attr">arrayFilters</span>: [&#123;</span><br><span class="line">            <span class="string">&#x27;e._id&#x27;</span>: goods_mongoId,</span><br><span class="line">          &#125;, &#123;</span><br><span class="line">            <span class="string">&#x27;val._id&#x27;</span>: batch_number_id</span><br><span class="line">          &#125;],</span><br><span class="line">          <span class="attr">multi</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h2><p>基础</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> MAPP.db_aggregateAll(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">condition</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">aggregate</span>: [],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>$filter</code> 过滤数组符合的元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">$project</span>: &#123;</span><br><span class="line">    <span class="attr">assigners</span>: &#123;</span><br><span class="line">      <span class="attr">$filter</span>: &#123;</span><br><span class="line">        <span class="attr">input</span>: <span class="string">&#x27;$assigners&#x27;</span>,</span><br><span class="line">        <span class="attr">as</span>: <span class="string">&#x27;item&#x27;</span>,</span><br><span class="line">        <span class="attr">cond</span>: &#123;</span><br><span class="line">          <span class="attr">$eq</span>: [<span class="string">&#x27;$$item.id&#x27;</span>, MAPP.MTypesId(staff_id)]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>$group</code>统计</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">$group</span>: &#123;</span><br><span class="line">    <span class="attr">_id</span>: <span class="string">&#x27;$product_list.product_id&#x27;</span>, <span class="comment">//需要统计的_id字段</span></span><br><span class="line">    <span class="comment">// 总价统计</span></span><br><span class="line">    <span class="attr">amount_stat</span>: &#123;</span><br><span class="line">      <span class="attr">$sum</span>: &#123; <span class="attr">$multiply</span>: [<span class="string">&#x27;$product_list.cypher_price&#x27;</span>, <span class="string">&#x27;$product_list.quantity&#x27;</span>] &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">product_id</span>: &#123;</span><br><span class="line">      <span class="attr">$first</span>: <span class="string">&#x27;$$ROOT.product_list.product_id&#x27;</span>, <span class="comment">//第一个统计字段</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">quantity_stat</span>: &#123;</span><br><span class="line">      <span class="attr">$sum</span>: <span class="string">&#x27;$product_list.quantity&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><code>$lookup</code> 连表 <code>unwind</code> 拆分</p>
<p>注:连表是数组,需要把数组拆分成对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">$lookup</span>: &#123;</span><br><span class="line">      <span class="attr">from</span>: <span class="string">&#x27;commodity&#x27;</span>, <span class="comment">//外表</span></span><br><span class="line">      <span class="attr">localField</span>: <span class="string">&#x27;group.kind_id&#x27;</span>, <span class="comment">//本表关联</span></span><br><span class="line">      <span class="attr">foreignField</span>: <span class="string">&#x27;_id&#x27;</span>, <span class="comment">//外表关联</span></span><br><span class="line">      <span class="attr">as</span>: <span class="string">&#x27;commodity&#x27;</span>, <span class="comment">//显示字段</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$unwind</span>: &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;$commodity&#x27;</span>, <span class="comment">//数组拆分</span></span><br><span class="line">      <span class="attr">preserveNullAndEmptyArrays</span>: <span class="literal">true</span> <span class="comment">// 空数组也拆分.</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> MAPP.db_aggregateAll(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&#x27;order_goods_record&#x27;</span>,</span><br><span class="line">  <span class="attr">isCount</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">pageTurn</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">aggregate</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">$match</span>: &#123;</span><br><span class="line">        <span class="attr">order_id</span>: MAPP.MTypesId(<span class="string">&#x27;63e9f04109ae774560a44829&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">$unwind</span>: &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;$product_list&#x27;</span>,</span><br><span class="line">        <span class="attr">preserveNullAndEmptyArrays</span>: <span class="literal">true</span> <span class="comment">// 空数组也拆分.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">$group</span>: &#123;</span><br><span class="line">        <span class="attr">_id</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;product_id&#x27;</span>: <span class="string">&#x27;$product_list.product_id&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;batch_id&#x27;</span>: <span class="string">&#x27;$product_list.batch_id&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;$product_list.type&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;activity_id&#x27;</span>: <span class="string">&#x27;$product_list.activity_id&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 第一个商品</span></span><br><span class="line">        <span class="attr">product_first</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;$first&#x27;</span>: <span class="string">&#x27;$product_list&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 统计金额</span></span><br><span class="line">        <span class="attr">amount_stat</span>: &#123;</span><br><span class="line">          <span class="attr">$sum</span>: &#123; <span class="attr">$multiply</span>: [<span class="string">&#x27;$product_list.final_price&#x27;</span>, <span class="string">&#x27;$product_list.spare_quantity&#x27;</span>] &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(result, <span class="number">123</span>)</span><br></pre></td></tr></table></figure>

<p>字符串截取 <code>$substr</code></p>
<p><a href="%E5%9C%B0%E5%9D%80">https://www.jianshu.com/p/8aa8794101e3</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(<span class="string">&#x27;notice&#x27;</span>).aggregate(</span><br><span class="line">  [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">$project</span>: &#123;</span><br><span class="line">        <span class="attr">content</span>: &#123; <span class="attr">$substrCP</span>: [<span class="string">&#x27;$content&#x27;</span>, <span class="number">0</span>, <span class="number">20</span>] &#125; <span class="comment">//从0开始截取长度为20的字符串</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>$$ROOT</code> 根元素过滤</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">$project</span>: &#123;</span><br><span class="line">    <span class="attr">goods_ids</span>: <span class="string">&#x27;$$ROOT.check.goods_ids&#x27;</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> MAPP.db_deleteOne(&#123;</span><br><span class="line">       <span class="attr">model</span>: <span class="string">&#x27;medicate_info&#x27;</span>,</span><br><span class="line">       <span class="attr">condition</span>: &#123;</span><br><span class="line">         <span class="attr">_id</span>: $id</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">     <span class="keyword">if</span> (res.ok &amp;&amp; res.value) &#123;</span><br><span class="line">       ctx.info(&#123; <span class="attr">message</span>: <span class="string">&#x27;删除成功&#x27;</span> &#125;)</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       ctx.info(&#123; <span class="attr">message</span>: <span class="string">&#x27;删除失败&#x27;</span>, <span class="attr">status</span>: <span class="number">403</span> &#125;)</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h2 id="通用方法"><a href="#通用方法" class="headerlink" title="通用方法"></a>通用方法</h2><h2 id="MAPP"><a href="#MAPP" class="headerlink" title="MAPP"></a><code>MAPP</code></h2><p>路径 <code>\api-medicalCenter\libs\utils\</code></p>
<p><code>plus</code> 加 <code>minus</code> 减 <code>multiply</code> 乘 <code>division</code> 除</p>
<p><code>selectTime</code> 获取时间范围</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传入</span></span><br><span class="line"><span class="comment">// Month: 本月 LastMonth: 上月 Yesterday:昨天 Day: 今天</span></span><br><span class="line"><span class="comment">// LastWeek:上周  Week: 本周  Year:今年 LastYear:去年</span></span><br><span class="line"><span class="keyword">const</span> timeRange = MAPP.selectTime(<span class="string">&#x27;Today&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(timeRange) <span class="comment">// [ 1658764800000, 1658851199999 ]</span></span><br></pre></td></tr></table></figure>

<p><code>formatFloat</code> 保留几位小数(四舍五入)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = MAPP.formatFloat(<span class="string">&#x27;2.567&#x27;</span>, <span class="number">2</span>) <span class="comment">// 2.57</span></span><br></pre></td></tr></table></figure>

<p><code>formatMoney</code> 保留金额两位</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = MAPP.formatMoney(<span class="number">5.335</span>) <span class="comment">// 5.34</span></span><br></pre></td></tr></table></figure>

<p><code>identityGetAge</code> 身份证获取年龄</p>
<p><code>110101190001011009</code></p>
<p><code>220202202002020022</code></p>
<p><a target="_blank" rel="noopener" href="http://www.ip33.com/shenfenzheng.html">在线身份证号码验证</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> age = MAPP.identityGetAge(<span class="string">&#x27;220202202002020022&#x27;</span>) <span class="comment">//2</span></span><br></pre></td></tr></table></figure>

<p>方法代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 身份证获取年龄</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">identityGetAge</span>(<span class="params">u = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">  u = u.toString()</span><br><span class="line">  <span class="keyword">let</span> len = (u + <span class="string">&#x27;&#x27;</span>).length</span><br><span class="line">  <span class="keyword">let</span> strBirthday = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> (len === <span class="number">18</span>) &#123;</span><br><span class="line">    <span class="comment">// 处理18位的身份证号码从号码中得到生日和性别代码</span></span><br><span class="line">    strBirthday =</span><br><span class="line">    u.substr(<span class="number">6</span>, <span class="number">4</span>) +</span><br><span class="line">      <span class="string">&#x27;/&#x27;</span> +</span><br><span class="line">      u.substr(<span class="number">10</span>, <span class="number">2</span>) +</span><br><span class="line">      <span class="string">&#x27;/&#x27;</span> +</span><br><span class="line">      u.substr(<span class="number">12</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (len === <span class="number">15</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> birthdayValue = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    birthdayValue = u.charAt(<span class="number">6</span>) + u.charAt(<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">parseInt</span>(birthdayValue) &lt; <span class="number">10</span>) &#123;</span><br><span class="line">      strBirthday =</span><br><span class="line">        <span class="string">&#x27;20&#x27;</span> +</span><br><span class="line">        u.substr(<span class="number">6</span>, <span class="number">2</span>) +</span><br><span class="line">        <span class="string">&#x27;/&#x27;</span> +</span><br><span class="line">        u.substr(<span class="number">8</span>, <span class="number">2</span>) +</span><br><span class="line">        <span class="string">&#x27;/&#x27;</span> +</span><br><span class="line">        u.substr(<span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      strBirthday =</span><br><span class="line">        <span class="string">&#x27;19&#x27;</span> +</span><br><span class="line">        u.substr(<span class="number">6</span>, <span class="number">2</span>) +</span><br><span class="line">        <span class="string">&#x27;/&#x27;</span> +</span><br><span class="line">        u.substr(<span class="number">8</span>, <span class="number">2</span>) +</span><br><span class="line">        <span class="string">&#x27;/&#x27;</span> +</span><br><span class="line">        u.substr(<span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 时间字符串里，必须是“/”</span></span><br><span class="line">  <span class="keyword">let</span> birthDate = <span class="keyword">new</span> <span class="built_in">Date</span>(strBirthday)</span><br><span class="line">  <span class="keyword">let</span> nowDateTime = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">  <span class="keyword">let</span> age = nowDateTime.getFullYear() - birthDate.getFullYear()</span><br><span class="line">  <span class="comment">// 再考虑月、天的因素;.getMonth()获取的是从0开始的，这里进行比较，不需要加1</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    nowDateTime.getMonth() &lt; birthDate.getMonth() ||</span><br><span class="line">    (nowDateTime.getMonth() === birthDate.getMonth() &amp;&amp;</span><br><span class="line">      nowDateTime.getDate() &lt; birthDate.getDate())</span><br><span class="line">  ) &#123;</span><br><span class="line">    age--</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> age.toString() === <span class="string">&#x27;NaN&#x27;</span> ? <span class="number">0</span> : <span class="built_in">Number</span>(age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>identityGetAge</code> 身份证获取生日</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> identityGetBirth = <span class="function">(<span class="params">u = <span class="string">&#x27;&#x27;</span>, s = <span class="string">&#x27;-&#x27;</span></span>) =&gt;</span> &#123;</span><br><span class="line">  u = u.toString()</span><br><span class="line">  <span class="keyword">let</span> len = (u + <span class="string">&#x27;&#x27;</span>).length</span><br><span class="line">  <span class="keyword">let</span> strBirthday = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> (len === <span class="number">18</span>) &#123;</span><br><span class="line">    <span class="comment">// 处理18位的身份证号码从号码中得到生日和性别代码</span></span><br><span class="line">    strBirthday = u.substr(<span class="number">6</span>, <span class="number">4</span>) + s + u.substr(<span class="number">10</span>, <span class="number">2</span>) + s + u.substr(<span class="number">12</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//第一代身份证15位,现在基本没有了</span></span><br><span class="line">  <span class="keyword">if</span> (len === <span class="number">15</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> birthdayValue = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    birthdayValue = u.charAt(<span class="number">6</span>) + u.charAt(<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">parseInt</span>(birthdayValue) &lt; <span class="number">10</span>) &#123;</span><br><span class="line">      strBirthday =</span><br><span class="line">        <span class="string">&#x27;20&#x27;</span> +</span><br><span class="line">        u.substr(<span class="number">6</span>, <span class="number">2</span>) +</span><br><span class="line">        s +</span><br><span class="line">        u.substr(<span class="number">8</span>, <span class="number">2</span>) +</span><br><span class="line">        s +</span><br><span class="line">        u.substr(<span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      strBirthday =</span><br><span class="line">        <span class="string">&#x27;19&#x27;</span> +</span><br><span class="line">        u.substr(<span class="number">6</span>, <span class="number">2</span>) +</span><br><span class="line">        s +</span><br><span class="line">        u.substr(<span class="number">8</span>, <span class="number">2</span>) +</span><br><span class="line">        s +</span><br><span class="line">        u.substr(<span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> strBirthday</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> a= identityGetBirth(<span class="string">&#x27;220202202002020022&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(a) <span class="comment">//&quot;2020-02-02&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>identityGetSex</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按身份证号码获取性别</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@idNumber </span>身份证号码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>男：male；女：female；异常（身份证号码为空或长度、格式错误）：undefined</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">identityGetSex</span>(<span class="params">idNumber=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (idNumber) &#123;</span><br><span class="line">    <span class="keyword">let</span> genderCode=<span class="string">&#x27;&#x27;</span> <span class="comment">// 性别代码</span></span><br><span class="line">    <span class="keyword">if</span> (idNumber.length === <span class="number">18</span>) &#123; <span class="comment">// 二代身份证号码长度为18位（第17位为性别代码）</span></span><br><span class="line">      genderCode = idNumber.charAt(<span class="number">16</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idNumber.length === <span class="number">15</span>) &#123; <span class="comment">// 一代身份证号码长度为15位（第15位为性别代码）</span></span><br><span class="line">      genderCode = idNumber.charAt(<span class="number">14</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (genderCode &amp;&amp; !<span class="built_in">isNaN</span>(genderCode)) &#123;</span><br><span class="line">      <span class="comment">// 两代身份证号码的性别代码都为男奇女偶</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">parseInt</span>(genderCode) % <span class="number">2</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;female&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;male&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> male=identityGetSex(<span class="string">&#x27;220202202002020022&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(male,<span class="string">&#x27;111&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h2><p>路径 <code>\api-medicalCenter\middleware</code></p>
<p>validator 校验 userAuth 不用登录</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">userAuth</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">validator</span>: &#123;</span><br><span class="line">    <span class="attr">verification_code</span>: <span class="string">&#x27;required|min:6&#x27;</span>,</span><br><span class="line">    <span class="attr">phone</span>: <span class="string">&#x27;required|cellphoneNumber&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;required|min:6&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;order_group.*.order_number&#x27;</span>: <span class="string">&#x27;required|string&#x27;</span>,</span><br><span class="line">    <span class="attr">openid</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;required|in:order_library,premium_voucher,dr_appointmen,order_deposit,order_retainage&#x27;</span>,</span><br><span class="line">    <span class="attr">voucher_id</span>: [&#123; <span class="attr">required_if</span>: [<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;premium_voucher&#x27;</span>] &#125;, <span class="string">&#x27;mongodbId&#x27;</span>],  <span class="comment">//数组写法</span></span><br><span class="line">    <span class="attr">store_ids</span>: <span class="string">&#x27;required|split-mongodbId&#x27;</span>, <span class="comment">//mongodbId逗号隔开</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>多个|隔开<br><code>required</code> 必传<br><code>min:6</code> 最小 6 位<br><code>split-mongodbId</code> 数组 id</p>
<p>常用<br><code>mongodbId</code> <code> numeric</code> <code>object</code> <code>string</code> <code>array</code></p>
<p><code>fullName</code> 姓名应该在 2-4 个中文字符<br><code>IDCard</code> 身份证号码验证<br><code>phoneNumber</code></p>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>注:</p>
<ol>
<li><code>本地测试要配置nginx中的server_name地址参数</code></li>
<li><code>获取去掉配置</code></li>
</ol>
<p>数据缓存<br>路径 <code>\api-medicalCenter\src\@common\cache</code></p>
<p>促商品缓存<br>路径 <code>\api-medicalCenter\src\@common\promotion</code></p>
<p>缓存进程<br>路径 <code>\api-medicalCenter\src\@common\process</code></p>
<p>/**</p>
<ul>
<li>类型 genre: cache promotion</li>
<li>方式</li>
<li>cache</li>
<li>0 allCache 1 cacheBrandCommodity 2 cacheBrandAssort 3 cacheCategoriesCommodity 4 cacheCategoriesAssort</li>
<li>5 cacheCommodityIntegral 6 cacheCourierCompanyAssort 7 cacheIntegralGoods 8 cacheCouponGoods 9 cacheMemberGrade</li>
<li>10 cacheStore 11 cacheMallGuideAssort 12 cacheDistributionGoods 13 cacheCommodityIntegralDeduction 14 cacheCommodity</li>
<li>promotion</li>
<li>0 allStoreRule 1 cipherRule<br>*/<br>调用方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> process_child = fork(MAPP.resolvePath(<span class="string">&#x27;src/@common/process.js&#x27;</span>))</span><br><span class="line">process_child.send(&#123; <span class="attr">genre</span>: <span class="string">&#x27;promotion&#x27;</span>, <span class="attr">method</span>: [<span class="number">1</span>], <span class="attr">conditions</span>: &#123; <span class="number">1</span>: &#123; <span class="attr">store_id</span>: existence.store_ids, <span class="attr">genre</span>: <span class="string">&#x27;reduction&#x27;</span> &#125; &#125; &#125;)  <span class="comment">//满减</span></span><br></pre></td></tr></table></figure>

<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>创建索引</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> MAPP.db_getDataModel(<span class="string">&#x27;commodity&#x27;</span>).collection.createIndex(&#123; <span class="attr">name</span>: <span class="string">&#x27;text&#x27;</span> &#125;)</span><br><span class="line"><span class="comment">// name_text</span></span><br></pre></td></tr></table></figure>

<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43665821/article/details/125579864">Windows 下开启副本集</a></p>
<p><strong>事务 demo 代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> session = <span class="keyword">await</span> MAPP.Mongoose.startSession() <span class="comment">// 启用事务</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> session.startTransaction() <span class="comment">// 开始事务</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> MAPP.db_setOne(&#123;</span><br><span class="line">    <span class="attr">model</span>: <span class="string">&#x27;commodity&#x27;</span>,</span><br><span class="line">    <span class="attr">condition</span>: &#123;</span><br><span class="line">        <span class="attr">_id</span>: <span class="string">&#x27;58805dd61d8bdc9c56cc3e2d&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">data</span>: &#123; <span class="attr">$set</span>: &#123; <span class="attr">common_name</span>: <span class="string">&#x27;氢溴酸右美沙芬片[测试]&#x27;</span> &#125; &#125;,</span><br><span class="line">    <span class="attr">options</span>: &#123;</span><br><span class="line">        session,</span><br><span class="line">        <span class="attr">new</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(result.common_name) <span class="comment">// 修改后的结果</span></span><br><span class="line">    <span class="comment">// eslint-disable-next-line no-throw-literal</span></span><br><span class="line">    <span class="comment">// throw &#x27;Too big&#x27; // 抛出错误</span></span><br><span class="line">    <span class="comment">// to do something..... 代码业务方法</span></span><br><span class="line">    <span class="keyword">await</span> session.commitTransaction() <span class="comment">// 提交事务</span></span><br><span class="line">    <span class="keyword">await</span> session.endSession()</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">await</span> session.abortTransaction() <span class="comment">// 终止事务</span></span><br><span class="line">    <span class="keyword">await</span> session.endSession()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="微信模板"><a href="#微信模板" class="headerlink" title="微信模板"></a>微信模板</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信服务订阅</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;wx_service_subscription&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MAPP.injectDBModel(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 模板名称 1.售后状态通知  2.订单发货通知 3.缴费通知 4.续费成功通知 5.待尾款提示 6.用药提醒 7.复购提醒 8.订单审核通知</span></span><br><span class="line">    <span class="attr">name</span>: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">default</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">    <span class="comment">// 模版id</span></span><br><span class="line">    <span class="attr">template_id</span>: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">default</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">    <span class="comment">// 是否启用</span></span><br><span class="line">    <span class="attr">enable</span>: &#123; <span class="attr">type</span>: <span class="built_in">Boolean</span>, <span class="attr">default</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  name</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>用药提醒</strong></p>
<table>
<thead>
<tr>
<th>字段说明</th>
<th>参数</th>
</tr>
</thead>
<tbody><tr>
<td>药品名称</td>
<td><code>&#123;&#123;thing1.DATA&#125;&#125;</code></td>
</tr>
<tr>
<td>用法用量</td>
<td><code>&#123;&#123;thing6.DATA&#125;&#125;</code></td>
</tr>
<tr>
<td>注意事项</td>
<td><code>&#123;&#123;thing7.DATA&#125;&#125;</code></td>
</tr>
</tbody></table>
<p>说明:在订单支付后绑定模板 id 触发</p>
<p><strong>复购提醒</strong></p>
<p><code>&#123;thing1:&#123;value:&quot;&quot;&#125;&#125;</code> 最多 20 个中文字符,超出无法发送</p>
<table>
<thead>
<tr>
<th>字段说明</th>
<th>参数</th>
</tr>
</thead>
<tbody><tr>
<td>药品信息</td>
<td><code>&#123;&#123;thing1.DATA&#125;&#125;</code></td>
</tr>
<tr>
<td>温馨提示</td>
<td><code>&#123;&#123;thing3.DATA&#125;&#125;</code></td>
</tr>
</tbody></table>
<p>说明:</p>
<ol>
<li>定时器每日 8 点推送 (最近 1 个月内商品订单信息开始推送)</li>
<li>复购推送规则</li>
</ol>
<ul>
<li>待收货,已完成交易,已授权未推送过的订单</li>
<li>推送时间:发货时间 + 疗程时间 &lt;=当前时间</li>
<li>推送疗程为下一个最近时间的疗程</li>
<li>购买的数量没有在疗程内,不推送消息</li>
<li>推送内容[药品信息][温馨提示](文字内容不超过 20 个字符)</li>
</ul>
<p>用药提醒例子:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = &#123;</span><br><span class="line">  <span class="attr">thing3</span>: &#123; <span class="attr">value</span>: v.name || <span class="string">&#x27;------&#x27;</span> &#125;, <span class="comment">// 药品名称</span></span><br><span class="line">  <span class="attr">thing6</span>: &#123; <span class="attr">value</span>: v.usage || <span class="string">&#x27;------&#x27;</span> &#125;, <span class="comment">// 用法用量</span></span><br><span class="line">  <span class="attr">thing7</span>: &#123; <span class="attr">value</span>: v.precautions || <span class="string">&#x27;------&#x27;</span> &#125; <span class="comment">// 注意事项</span></span><br><span class="line"><span class="comment">// console.log()</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 推送消息</span></span><br><span class="line"><span class="keyword">await</span> wx.subscribeMessage(&#123;</span><br><span class="line">  <span class="attr">touser</span>: openid,</span><br><span class="line">  <span class="attr">page</span>: <span class="string">`pagesD/indent/details?_id=<span class="subst">$&#123;order._id&#125;</span>`</span>,</span><br><span class="line">  <span class="attr">template_id</span>: wx_service_subscription.template_id,</span><br><span class="line">  <span class="attr">miniprogramState</span>: CONFIG.miniprogramState,</span><br><span class="line">  data,</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data)</span><br><span class="line">  <span class="comment">// 用户拒绝或者没有订阅消息</span></span><br><span class="line">  <span class="comment">// &#123;</span></span><br><span class="line">  <span class="comment">//   errcode: 43101,</span></span><br><span class="line">  <span class="comment">//   errmsg: &#x27;user refuse to accept the msg rid: 62fc6378-7f857407-1a8a6b2c&#x27;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Number</span>(data.errcode) === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;微信订阅通知发送成功！&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="后台"><a href="#后台" class="headerlink" title="后台"></a>后台</h1><p>配置</p>
<blockquote>
<p><code>npm run copyConfig</code></p>
</blockquote>
<p>开发版配置设置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = <span class="string">&#x27;xcx.fenxiangqu.cn&#x27;</span></span><br><span class="line"><span class="keyword">const</span> ossUrl = <span class="string">&#x27;https://syhl-newretail-dev.oss-cn-shenzhen.aliyuncs.com&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    api: &#123;</span><br><span class="line">    BASE_API: `http:<span class="comment">//192.168.1.208:4556`,</span></span><br><span class="line">    <span class="comment">// 上传 请求</span></span><br><span class="line">    UPLOAD_URL: `http:<span class="comment">//192.168.1.208:4556`,</span></span><br><span class="line">    <span class="comment">// websocket 请求</span></span><br><span class="line">    WSS_URL: `ws:<span class="comment">//192.168.1.208:3378/websocket`,</span></span><br><span class="line">    <span class="comment">// 资源访问</span></span><br><span class="line">    RESOURCES_URL: ossUrl,</span><br><span class="line">    <span class="comment">// b2c 微商城</span></span><br><span class="line">    B2C_APP_URL: &#x27;&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="消息中心"><a href="#消息中心" class="headerlink" title="消息中心"></a>消息中心</h1><p>数据表 <code>message_center</code> <code>order_type</code> 4 商品订单 5 退款订单<br>推送消息到后台方法 <code>pushBackstageMsg</code><br>推送全部 <code>to_user_id: &#39;all&#39;</code></p>
<ol>
<li><p>支付订单推送 用户支付订单成功后自动推送</p>
</li>
<li><p>退款单推送 用户申请退款单自动推送</p>
</li>
</ol>
<p>推送规则</p>
<ol>
<li>超级管理员和有关联该订单门店管理员</li>
<li>一个订单推送一条消息</li>
<li>按门店推送</li>
</ol>
<h1 id="b2c"><a href="#b2c" class="headerlink" title="b2c"></a>b2c</h1><h2 id="推荐商品"><a href="#推荐商品" class="headerlink" title="推荐商品"></a>推荐商品</h2><p><code>/commodity/recommend/random</code></p>
<p>类型:1 首页 2 详情推荐</p>
<p>说明: 推荐商品必须库存大于 0,上架状态</p>
<p>一, b2c 首页推荐</p>
<p>9 个可以自定义</p>
<ol>
<li>最多设置 50 个推荐商品</li>
<li>b2c 前台最多随机 9 个推荐商品</li>
<li>超过 9 个才会随机</li>
<li>小于 9 个推荐商品 + 普通商品</li>
</ol>
<p>二, 详情推荐</p>
<ol>
<li>最多随机 8 个商品(关联相同商品的品牌,分类)</li>
</ol>
<h2 id="限销"><a href="#限销" class="headerlink" title="限销"></a>限销</h2><p>下单算该商品已购买的数量了(已取消订单不算)</p>
<p>限销拦截以下</p>
<ol>
<li>加入购物车</li>
<li>设置商品数量</li>
<li>立即购买</li>
<li>提交订单</li>
<li>支付订单</li>
</ol>
<h2 id="前台商品搜索"><a href="#前台商品搜索" class="headerlink" title="前台商品搜索"></a>前台商品搜索</h2><ol>
<li><p><strong>b2c 前台商品列表搜索条件</strong>(/commodity)</p>
<ul>
<li>主要搜索<br>name 商品名称/条码/厂家</li>
<li>其他搜索<br>brand_id 品牌 id<br>categories_id 分类 id<br>prescription 处方药类型<br>for_people 适合人群<br>in_stock 是否有货 (<code>distributed.stock</code>)<br>new_product 是否新品 (<code>distributed.new_product</code>)<br>promotion 促销类型(满赠,满赠) (<code>distributed.gift_ids</code> <code>distributed.reduction_ids</code>)</li>
<li>排序<br>price_sort 价格降升序 (<code>distributed.current_price</code>)<br>sales_sort 销量排序 (<code>distributed.sales</code>)</li>
</ul>
</li>
<li><p><strong>b2c 前台跨境商品列表搜索</strong>(/commodity/overseas)</p>
<ul>
<li>主要搜索 name 商品名称/条码</li>
<li>排序 sort 字段降序</li>
</ul>
</li>
<li><p><strong>b2c 前台其他商品排序</strong>(/commodity/leaderboard /floor/:id)</p>
<ul>
<li>楼层 库存降序 (<code>distributed.stock</code>)</li>
<li>商品排行榜 销量降序 (<code>distributed.sales</code>)</li>
</ul>
</li>
</ol>
<h1 id="分销"><a href="#分销" class="headerlink" title="分销"></a>分销</h1><h2 id="珍药优选"><a href="#珍药优选" class="headerlink" title="珍药优选"></a>珍药优选</h2><p>1.前台结算只能选择珍药商品结算</p>
<h2 id="分销佣金"><a href="#分销佣金" class="headerlink" title="分销佣金"></a>分销佣金</h2><p><a target="_blank" rel="noopener" href="https://szsyhl.yuque.com/books/share/df982670-d0a3-47af-b353-4650ee6a4dfd/dx56dt">分销佣金指南(雨雀)</a></p>
<p>个人分销商佣金字段(表<code>distributor</code>)</p>
<p><code>wait_commission</code>: 待结算<br><code>commission</code> 已结算<br><code>extractable_commission</code> 可提取<br><code>already_commission</code> 已提取</p>
<h2 id="佣金结算"><a href="#佣金结算" class="headerlink" title="佣金结算"></a>佣金结算</h2><ol>
<li>提交订单(含分销商品)生成分销单(表<code>distribution_order</code>)</li>
</ol>
<p>方法: 普通分销 <code>distributorOrder</code> 特殊分销 <code>codeDistributorOrder</code></p>
<ol start="2">
<li><p>支付订单生成分销收入明细(表<code>distribution_income_details</code>) 未到账<br>方法: <code>distributionIncome</code><br>说明 1: 分销单中分销收益有两条数据生成两条明细<br>说明 2: 明细结余(待结算+已结算+可提取)<br>说明 3: 全部退款取消订单 删除分销收入明细数据</p>
</li>
<li><p>确认收货结算佣金(表<code>distributor</code>)<br>方法: <code>distributionIReceipt</code><br>说明 1: 按结算规则判断分销商个人佣金对应字段结算<br>说明 2: 更新收入分销明细结字段<br>结算规则:</p>
<ol>
<li><strong>settlement_data=0 release_date=0</strong> <code>extractable_commission</code> 可提现</li>
<li><strong>settlement_data=0 release_date&gt;0</strong> <code>commission</code> 已结算</li>
<li><strong>settlement_data&gt;0</strong> <code>wait_commission</code> 待结算</li>
</ol>
</li>
<li><p>结算定时器<br>方法: <code>settlementCommission</code><br>说明:</p>
<ol>
<li>结算日 已结算增加 待结算减少</li>
<li>发放日 可提取增加 已提取减少</li>
</ol>
</li>
</ol>
<p>后台账户佣金: 已结算+可提现</p>
<p>b2c 前台账户佣金<br>累计收益: 已结算+可提取+已提现<br>今日预估收入:今天分销收入明细<code>amount</code>字段累加(含未到账,创建时间)<br>本月预估收入:本月分销收入明细<code>amount</code>字段累加(含未到账,创建时间)<br>账户余额: 已结算+可提现</p>
<h1 id="店员端"><a href="#店员端" class="headerlink" title="店员端"></a>店员端</h1><p><strong>app_shop_assistant</strong></p>
<h1 id="webpos"><a href="#webpos" class="headerlink" title="webpos"></a>webpos</h1><h2 id="退款"><a href="#退款" class="headerlink" title="退款"></a>退款</h2><p>webpos 退款功能说明:</p>
<ol>
<li>全部退款可以按原路退或按现金退</li>
<li>部分退款,按原路退或现金退(单支付)</li>
<li>部分退款,只能按现金退(多支付)</li>
<li>退款金额不能超出订单实收金额</li>
<li>自定义退款数量不能超出商品原数量</li>
<li>退款金额为商品最终价格金额(平摊后的金额)</li>
<li>退款金额不能超出商品平摊后的金额</li>
</ol>
<h2 id="收银台"><a href="#收银台" class="headerlink" title="收银台"></a>收银台</h2><p><code>order_total</code> 应收金额 (订单金额)<br><code>pay_total</code> 实付金额<br><code>coupon_amount</code> 优惠券抵扣金额<br><code>discount_amount</code> 促销优惠金额 (满减金额)<br><code>member_amount</code> 会员优惠金额 (会员价/内购价)<br><code>whole_amount</code> 整单改价金额 (整单/单品字段二选一)<br><code>single_amount</code> 单品改价金额 (整单/单品字段二选一)</p>
<p><code>save_data.is_change_price</code> = false 是否自动切换价格(切换会员默认选择最优会员价)<br><code>save_data.no_change</code> = true 是否处理商品会员价/内购价</p>
<p><code>save_data.pay_total</code> = 0 重新计算应收金额<br><code>save_data.coupon_amount</code> = 0 重新计算优惠券金额</p>
<p><code>getPendingOne</code> 获取默认挂单信息</p>
<p><code>getPendingOrder</code> 获取挂单详细信息</p>
<p><code>productSum</code> 计算商品金额支付</p>
<p><code>savePendingOrder</code> 保存挂单信息</p>
<p><code>fullReductionOffer</code> 满减处理方法</p>
<p><code>fullGiftOffer</code> 满赠处理方法</p>
<p><code>optimalAmount</code> 处理最优解</p>
<p><code>goodPromotionRuleList</code> 获取所有商品促销类型</p>
<p><code>goodSortFn</code> 商品排序</p>
<p><code>disposeProductList</code> 处理商品字段</p>
<p><code>noBatchNumber</code> 只按商品销售 (清除批号数组)</p>
<p><code>disposeBatchNumber</code> 处理批号数据</p>
<p>收银台字段说明:</p>
<p>品种数量: 商品个数(对应商品最大的序号)<br>应收金额 = 商品总价相加<br>实收金额 = 应收金额 - 促销优惠 - 改价金额 - 优惠券金额</p>
<p>促销优惠 = 赠品金额 + 满减金额</p>
<h2 id="单品改价"><a href="#单品改价" class="headerlink" title="单品改价"></a>单品改价</h2><p>只有普通商品才能改价</p>
<p>会员价/内购价修改价格变成商城价</p>
<p>接口名 <code>/commodity/modify/:id</code></p>
<h2 id="促销"><a href="#促销" class="headerlink" title="促销"></a>促销</h2><p>优先级:</p>
<p>目前 webpos 添加顺序</p>
<ol>
<li>限时抢购 —&gt; 满减 —&gt; 满赠—&gt; 普通</li>
</ol>
<p>同个活动的优先级: 先按设置优先级,再按更新时间</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sort: &#123;</span><br><span class="line">  <span class="attr">priority</span>: -<span class="number">1</span>,</span><br><span class="line">  <span class="attr">update_time</span>: -<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>促销类型</strong></p>
<p><code>general</code> 普通商品<br><code>match_package</code> 组合套餐<br><code>redemption</code> 加钱换购<br><code>limited_time_buying</code> 限时抢购<br><code>presale</code> 预售<br><code>integral_exchange</code> 积分兑换</p>
<p>1.普通商品 2.限时抢购(限时,限量) 3.满减 4.满赠 5.组合套餐 6.换购 7.预售 8.积分兑换</p>
<p>门店商品库存不足时,下架状态无法下单购买</p>
<p>库存注意:</p>
<ol>
<li>webpos 库存按商品批号库存,b2c 库存按商品总库存判断</li>
<li>赠品活动库存目前版本已去掉(赠品库存按门店库存)</li>
<li>限时抢购设置商品活动库存为 0 时,不限时库存,为商品门店库存</li>
<li>组合套餐设置活动库存为 0 时,不限时库存,库存为组合商品内最小套餐数量</li>
<li>活动库存小于门店库存,按门店库存销售</li>
<li>webpos 批号排序:先按有效期日期近到远排序,如有效期一样,则按批号库存从大到小排序</li>
</ol>
<p>组合商品库存 1.当活动库存大于 0 时,以门店库存为主,必须小于活动库存 2.当活动库存等于 0 时(没限制库存) 以活动库存为主</p>
<p>简单功能说明</p>
<table>
<thead>
<tr>
<th>促销类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>普通商品</td>
<td>普通商品含商城价/会员价/内购价,只有普通商品才能切换价格类型</td>
</tr>
<tr>
<td>限时抢购</td>
<td>限时(按时),限量(按日) (含活动价格,活动库存,限购数量)</td>
</tr>
<tr>
<td>满减</td>
<td><code>满购x元/件减y元</code>或 <code>满购x元/件打y折</code></td>
</tr>
<tr>
<td>满赠</td>
<td><code>购买x元/件送y件赠品</code> 加 <code>购买x元/件加送y件赠品</code> (已去掉赠品库存)</td>
</tr>
<tr>
<td>组合套餐</td>
<td>多个商品价格和数量捆绑合计 (含套餐价格,活动库存,限购数量)</td>
</tr>
<tr>
<td>换购</td>
<td>达到某个金额后,可以选择加钱换购多种商品 (含换购价格,活动库存,换购数量)</td>
</tr>
<tr>
<td>预售</td>
<td>商品先支付定金,在指定时间支付尾款 (含预售金额,定金,活动库存)</td>
</tr>
<tr>
<td>积分兑换</td>
<td>积分兑换商品 (含兑换库存,兑换价格)</td>
</tr>
</tbody></table>
<p>收银台/购物车说明:</p>
<ol>
<li>目前促销活动规则只能手动选择</li>
<li>同种商品只能用一个促销活动,不同种商品可以设置同种一个促销(满减,满赠)</li>
<li>订单可以有多个促销活动的商品</li>
<li>改价: 只能改普通商品的价格,不能修改促销商品价格</li>
<li>添加会员后,再添加商品默认带出商品最优价(会员价,内购价)</li>
<li>有满减促销时,先减满减金额,再减优惠券金额</li>
</ol>
<p>公式–商品分摊(订单含满减,优惠券)</p>
<ol>
<li>商品促销分摊 = (促销金额 ÷ 总金额) x 商品金额</li>
<li>商品优惠券分摊 = (优惠券金额 ÷ 总金额) x 商品金额</li>
<li>商品支付金额 = 商品金额 - 满减分摊- 优惠券分摊</li>
</ol>
<p>例子:</p>
<p><img src="/image/retail_core/jisuan.png" alt="jsuan.png"></p>
<h3 id="webpos-1"><a href="#webpos-1" class="headerlink" title="webpos"></a>webpos</h3><p><code>const goodPromotionRuleList</code> 处理,获取所有商品促销类型</p>
<p><code>const disposeProductList</code> 处理商品字段</p>
<p><code>const disposeBatchNumber</code> 处理所有商品批号库存</p>
<p>过滤条件:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> result = <span class="keyword">await</span> MAPP.db_queryAll(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&#x27;batch_number&#x27;</span>,</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;noPage&#x27;</span>,</span><br><span class="line">  <span class="attr">pageTurn</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">isCount</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">condition</span>: &#123;</span><br><span class="line">    store_id,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;合格&#x27;</span>,</span><br><span class="line">    <span class="attr">is_delete</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">goods_id</span>: &#123;</span><br><span class="line">      <span class="attr">$in</span>: good_ids_arr.reduce(<span class="function">(<span class="params">p, n</span>) =&gt;</span> p.concat(MAPP.MTypesId(n.toString())), []),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p><strong>b2c 立即购买</strong></p>
<p>最优促销规则</p>
<p><strong>商品列表</strong></p>
<p><code>order_total</code> 订单金额 (应收金额)<br><code>pay_total</code> 实付金额 (实收金额)</p>
<h2 id="配置打包"><a href="#配置打包" class="headerlink" title="配置打包"></a>配置打包</h2><p><strong>桌面应用包</strong></p>
<ol>
<li><p>在 <code>package.json</code> 中的 <code>dependencies</code> 添加以下三个依赖包(用 npm 安装)<br><code>&quot;electron&quot;: &quot;^12.0.0&quot;,</code><br><code>&quot;electron-devtools-installer&quot;: &quot;^3.1.0&quot;,</code><br><code>&quot;vue-cli-plugin-electron-builder&quot;: &quot;~2.0.0&quot;,</code></p>
<p>执行 electron:build 报错</p>
<p>在项目根目录新增<code>.npmrc</code> 文件</p>
<p>添加<br><code>ELECTRON_MIRROR=https://npm.taobao.org/mirrors/electron/</code></p>
<p>全局安装 npm install electron -g</p>
<p>安装失败处理: <code>npm config set ELECTRON_MIRROR http://npm.taobao.org/mirrors/electron/</code> //配置安装镜像源地址<br>打包失败处理: <code>npm config set ELECTRON_BUILDER_BINARIES_MIRROR https://mirrors.huaweicloud.com/electron-builder-binaries/</code> // 配置打包镜像源地址</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33973359/article/details/105602141">安装源说明</a></p>
</li>
<li><p>manifest.json 路由配置<code>history</code>改成<code>hash</code></p>
</li>
<li><p>运行打包</p>
</li>
</ol>
<p><code>npm run electron</code> 打包 64 位应用程序<br><code>npm run electron:build32</code> 打包 32 位应用程序</p>
<h2 id="商品"><a href="#商品" class="headerlink" title="商品"></a>商品</h2><p>获取所有商品促销类型 <code>const goodPromotionRuleList</code></p>
<p>处理商品促销字段提示合并组合商品和赠品,换购商品(重新加载商品列表) <code>const disposeProductList</code></p>
<h2 id="高德地图"><a href="#高德地图" class="headerlink" title="高德地图"></a>高德地图</h2><p>先创建<code>Web服务</code>应用(接口) <code>Web端</code>应用(页面)保存 key 和密钥</p>
<h1 id="库存"><a href="#库存" class="headerlink" title="库存"></a>库存</h1><p>新零售目前库存字段</p>
<ol>
<li><p>商品总库存</p>
<p>冻结数量<code>blocked_stock</code> 占用数量 <code>occupy_stock</code> 门店库存<code>stock</code></p>
<p>可销库存 = 门店库存 - 冻结数量 - 占用数量</p>
</li>
<li><p>批号库存 <code>stock</code> 冻结数量 <code>blocked_stock</code></p>
<p>可销库存 = 批号库存 - 冻结数量</p>
</li>
</ol>
<p>webpos 库存说明:</p>
<ol>
<li>目前销售先冻结或占用数量,同步日清后才去扣除掉门店账面库存数量,冻结和占用数量</li>
<li>页面显示的库存都是<code>可销库存</code></li>
<li>按批号销售:直接冻结商品所在批号数量和冻结商品总数量</li>
<li>按商品销售:商品销售自动分配批号,出现<code>负库存</code>,数量加在商品<code>占用数量</code>字段</li>
<li>日清结果:<br>① 更新商品账面和批号库存<br>② 更新订单商品批号数据和日清状态<br>③ 插入/更新新的库存流水记录</li>
</ol>
<h2 id="webpos-销售"><a href="#webpos-销售" class="headerlink" title="webpos 销售"></a>webpos 销售</h2><p><strong>总库存字段</strong></p>
<p>按商品销售:</p>
<p>可销库存 = 门店账面库存 - 冻结数量 - 占用数量</p>
<table>
<thead>
<tr>
<th align="center">例子</th>
<th align="center">商品 A</th>
<th align="center">批号 1</th>
<th align="center">批号 2</th>
<th align="center">数据(行)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">库存(件)</td>
<td align="center">15</td>
<td align="center">10</td>
<td align="center">5</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">1. 销售 10</td>
<td align="center">冻结:10,可销:5</td>
<td align="center">冻结:10,可销:0</td>
<td align="center">冻结:0,可销:5</td>
<td align="center">A1 x 10</td>
</tr>
<tr>
<td align="center">2. 销售 12</td>
<td align="center">冻结:12,可销:3</td>
<td align="center">冻结:10,可销:0</td>
<td align="center">冻结:2,可销:3</td>
<td align="center">A1 x 10 <br> A2 x 2</td>
</tr>
<tr>
<td align="center">3. 销售 20(负)</td>
<td align="center">冻结 15,可销:0,占用:5</td>
<td align="center">冻结:10,可销:0</td>
<td align="center">冻结:5,可销:0</td>
<td align="center">A1 x 10 <br> A2 x 5 <br> A (空) x 5</td>
</tr>
</tbody></table>
<p><u>带下划线的文本</u></p>
<p>门店商品批号库存查询<br><code>circulation_record</code></p>
<p>封装方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加批号库存记录</span></span><br><span class="line"><span class="keyword">await</span> addCirculationRecord(&#123;</span><br><span class="line">  <span class="attr">good_id</span>: commodity._id,</span><br><span class="line">  <span class="attr">batch_id</span>: batch_one ? batch_one._id : <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">quantity</span>: TRANSIT_QUANTITY,</span><br><span class="line">  <span class="attr">receipt_number</span>: PUT_NUMBER,</span><br><span class="line">  <span class="attr">receipt_type</span>: <span class="string">&#x27;c&#x27;</span>, <span class="comment">// 单据类型 a入库 b销售 c门店调拨 d退库 e初装 f盘点 g退款 h取消订单</span></span><br><span class="line">  operator = <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  operator_id = <span class="literal">null</span>,</span><br><span class="line">  store_id</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 扣商品库存</span></span><br><span class="line"><span class="keyword">await</span> MAPP.db_setOne(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&#x27;commodity&#x27;</span>,</span><br><span class="line">  <span class="attr">condition</span>: &#123; <span class="attr">_id</span>: commodity._id, <span class="string">&#x27;distributed.store_id&#x27;</span>: pick_store._id &#125;,</span><br><span class="line">  <span class="attr">data</span>: &#123; <span class="attr">$inc</span>: &#123; <span class="string">&#x27;distributed.$.stock&#x27;</span>: inc_stock &#125; &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>库存批号库存</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> MAPP.db_setOne(&#123;</span><br><span class="line">     <span class="attr">model</span>: <span class="string">&#x27;batch_number&#x27;</span>,</span><br><span class="line">     <span class="attr">condition</span>: &#123;</span><br><span class="line">       <span class="attr">_id</span>: batch_one._id</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">data</span>: &#123;</span><br><span class="line">       <span class="attr">$inc</span>: &#123;</span><br><span class="line">         <span class="attr">stock</span>: inc_stock</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="库存单据"><a href="#库存单据" class="headerlink" title="库存单据"></a>库存单据</h2><p>单据保护:审核前是否修改原单数据</p>
<p>只要有任一总部账号进入审核页面，均触发单据保护</p>
<p><code>data_protection</code> 请货单 盘点单 配送单 退库单</p>
<p>是否审核: 总店是否可审核其他门店单据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 盘点单是否需审核</span></span><br><span class="line">    <span class="attr">check_need_audit</span>: &#123; <span class="attr">type</span>: <span class="built_in">Boolean</span>, <span class="attr">default</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="comment">// 请货单是否需审核</span></span><br><span class="line">    <span class="attr">apply_lading_need_audit</span>: &#123; <span class="attr">type</span>: <span class="built_in">Boolean</span>, <span class="attr">default</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="comment">// 手录入库单是否需审核</span></span><br><span class="line">    <span class="attr">warehousing_need_audit</span>: &#123; <span class="attr">type</span>: <span class="built_in">Boolean</span>, <span class="attr">default</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="comment">// 门店退库单是否需审核</span></span><br><span class="line">    <span class="attr">refund_lading_need_audit</span>: &#123; <span class="attr">type</span>: <span class="built_in">Boolean</span>, <span class="attr">default</span>: <span class="literal">true</span> &#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="盘点单"><a href="#盘点单" class="headerlink" title="盘点单"></a>盘点单</h3><p>说明:</p>
<ol>
<li>完成盘点单后,需要判断是否需要审核</li>
<li>如需要审核,由中台总店审核和平账库存</li>
<li>如无需审核,则店员端自动审核通过并自动平账库存</li>
<li>审核通过后才会推送(每 2 分钟)</li>
</ol>
<h3 id="请货单"><a href="#请货单" class="headerlink" title="请货单"></a>请货单</h3><p>说明:</p>
<ol>
<li>子门店向子门店请货,不推送 erp,由子门店处理</li>
<li>子门店向总部请货,推送 erp,由 erp 同步接口出库单 (每 2 分钟同步一次)</li>
<li>请货单可以配置是否需要审核</li>
</ol>
<p>店员端:</p>
<p>A 门店—&gt;B 门店</p>
<p>A 门店 向 B 门店请货</p>
<p>一 、请货流程:</p>
<ol>
<li>选择发货门店</li>
<li>添加请货商品</li>
<li>设置商品请货数量</li>
<li>提交请货单</li>
<li>审核请货单(如审核驳回可以修改后重新提交)</li>
</ol>
<p>二 、出库流程 (子门店之间)</p>
<ol>
<li>B 门店生成拣货任务 (总部没有生成拣货任务)</li>
<li>获取根据请货单商品</li>
<li>选择商品批号和设置数量(子门店需要冻结库存)</li>
<li>确认出库 (减少账面库存)</li>
<li>A 门店生成收货任务</li>
</ol>
<p>三 、收货流程</p>
<ol>
<li>子门店之间,出库数量等于收货数量</li>
<li>总库出库,子门店收货可以不等于出库数量</li>
</ol>
<h3 id="出库单"><a href="#出库单" class="headerlink" title="出库单"></a>出库单</h3><p>说明:</p>
<ol>
<li>新零售出库单有关联请货单</li>
<li>erp 出库单可以不关联请货单</li>
</ol>
<h1 id="价格"><a href="#价格" class="headerlink" title="价格"></a>价格</h1><p>新零售目前商品价格: 普通价(零售价/现价) 会员价 付费会员价 内购价 (四种)</p>
<p>注意:</p>
<ol>
<li>若线下零售价为 0 时,用线上零售价</li>
<li>会员价包括商城会员价(免费),付费会员价</li>
<li>内购价针对职工内部(职工账号与会员手机号一致则享受内购价)</li>
</ol>
<p>设置等级会员价</p>
<ol>
<li>权益中心必须开启</li>
<li>设置商品折扣字段 (折扣大于 0)</li>
</ol>
<p><code>current_price</code> 零售价（线上）<br><code>current_price_offline</code> 零售价（线下）<br><code>staff_price</code> 内购价<br><code>member_price</code> 会员价<br><code>paid_price</code> plus 会员价</p>
<h2 id="会员价"><a href="#会员价" class="headerlink" title="会员价"></a>会员价</h2><p>说明:</p>
<ol>
<li>普通会员优先级: 商品指定价 &gt; 其它等级商品折扣</li>
<li>折扣值范围: 0 &lt; 折扣 &lt; 10</li>
<li>会员价计算: 会员价 = 零售价 x 折扣 x 0.1</li>
<li>会员价有可能会大于零售价</li>
<li>优惠金额: 零售价 - 会员价 (可正可负)</li>
</ol>
<p>例子:<br>A 商品 10 元,享折扣八折<br>会员价: 10x8x0.1=8(元)</p>
<p><code>member_price</code> 普通会员价商品表(指定)</p>
<p><code>mall_member</code> 普通会员等级表</p>
<p>字段结构</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;member_benefits&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span> : <span class="string">&quot;discount&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;number&quot;</span> : <span class="number">8</span>,</span><br><span class="line">        <span class="string">&quot;key_ids&quot;</span> : [],</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;63f85eca8cd8ed367bb1aa97&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 获取方法</span></span><br><span class="line"> <span class="comment">// 普通会员价</span></span><br><span class="line">  <span class="keyword">const</span> &#123; member_price = <span class="number">0</span>, is_member &#125; = <span class="keyword">await</span> getMemberPrice(&#123; <span class="attr">current_price</span>: commodity.current_price, user_id &#125;)</span><br><span class="line">  commodity.member_price = member_price</span><br><span class="line">  commodity.is_member = is_member</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//批量修改</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> memberGoods(&#123; <span class="attr">pageTurn</span>: <span class="literal">false</span>, <span class="attr">good_list</span>: result, store_id, user_id &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="plus-会员价"><a href="#plus-会员价" class="headerlink" title="plus 会员价"></a>plus 会员价</h2><p>说明:</p>
<ol>
<li>plus 会员优先级: 商品指定价&gt; 专属商品折扣 &gt; 其它商品折扣</li>
<li>折扣值范围: 0 &lt; 折扣 &lt; 10</li>
<li>会员价计算: 会员价 = 零售价 x 折扣 x 0.1</li>
</ol>
<p><code>paid_price</code> 付费会员价商品表(指定)</p>
<p><code>paid_member</code> 付费 plus 会员表</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;member_benefits&quot;</span> : [</span><br><span class="line">    <span class="comment">//专属商品折扣</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span> : <span class="string">&quot;exclusive_merchandise&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number&quot;</span> : <span class="number">7</span>,</span><br><span class="line">      <span class="comment">//专属商品折扣</span></span><br><span class="line">      <span class="string">&quot;key_ids&quot;</span> : [</span><br><span class="line">        ObjectId(<span class="string">&quot;58805dd61d8bdc9c56cc3e31&quot;</span>),</span><br><span class="line">        ObjectId(<span class="string">&quot;58805dd61d8bdc9c56cc3e32&quot;</span>),</span><br><span class="line">      ],</span><br><span class="line">      <span class="comment">//指定商品价</span></span><br><span class="line">      <span class="string">&quot;goods_ids&quot;</span> : [</span><br><span class="line">        ObjectId(<span class="string">&quot;58805dd61d8bdc9c56cc3e3c&quot;</span>),</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;63f7139568a92829840ec51a&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//其它商品折扣</span></span><br><span class="line">      <span class="string">&quot;type&quot;</span> : <span class="string">&quot;discount&quot;</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;number&quot;</span> : <span class="number">8</span>,</span><br><span class="line">      <span class="string">&quot;key_ids&quot;</span> : [],</span><br><span class="line">      <span class="string">&quot;goods_ids&quot;</span> : [],</span><br><span class="line">      <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;63f7139568a92829840ec518&quot;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取方法</span></span><br><span class="line"><span class="keyword">const</span> obj = <span class="keyword">await</span> getPaidPrice(&#123; <span class="attr">current_price</span>: commodity.current_price, user_id &#125;, ctx)</span><br><span class="line">commodity.paid_price = obj.paid_price</span><br><span class="line">commodity.is_paid = obj.is_paid</span><br></pre></td></tr></table></figure>

<h1 id="订单"><a href="#订单" class="headerlink" title="订单"></a>订单</h1><h1 id="客服"><a href="#客服" class="headerlink" title="客服"></a>客服</h1><p>说明:</p>
<ol>
<li>按门店匹配</li>
</ol>
<h2 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h2><p>自动调度说明(定时器)</p>
<ol>
<li>开启自动调度配置,设置无响应时间</li>
<li>所有未接入的对话 (有对话过的)</li>
<li>对话更新时间小于(当前时间 - 无响应时间)</li>
</ol>
<h2 id="商品-1"><a href="#商品-1" class="headerlink" title="商品"></a>商品</h2><p><code>product_list</code></p>
<p>单个商品价格:<br><code>price</code>：零售价<br><code>cypher_price</code> : 普通价(零售价/会员价/plus 价/内购价)<br><code>reduction_number</code>: 满减抵扣金额<br><code>coupon_number</code>: 优惠券抵扣金额<br><code>member_number</code>: 会员抵扣金额<br><code>integral_price</code>: 积分抵扣金额<br><code>final_price</code> 最终价格(实际支付价格)</p>
<p>达到满减条件为:</p>
<ol>
<li>满减活动商品实际支付总价 &gt;= 满减门槛规则金额</li>
<li>满减活动商品总件数 &gt;= 满减门槛件数</li>
</ol>
<p>满减满足金额为普通商品<code>cypher_price</code>计算判断</p>
<p>优惠券可用条件为: 总商品实际支付总价 - 满减金额 &gt;= 优惠券门槛金额</p>
<p>价格计算</p>
<p>普通价 = 零售价 - 折扣金额 - 改价金额</p>
<p><code>cypher_price</code> = <code>price</code> - <code>member_number</code> - <code>change_number</code></p>
<p>支付价 = 普通价 - 满减金额 - 优惠券金额 - 积分抵扣金额</p>
<p><code>final_price</code> = <code>cypher_price</code> - <code>reduction_number</code> - <code>coupon_number</code> - <code>integral_price</code></p>
<p><code>注</code>:</p>
<ol>
<li>如抵扣金额(优惠金额小于 0.01 元)按 0 元计算</li>
<li>webpos 达到满减条件为: 满减活动商品零售价总价 &gt;= 满减门槛规则金额</li>
</ol>
<h1 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h1><p>型号 :Xprinter 58</p>
<h2 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h2><p>易语言安装与破解说明：<br>一、解压后，先安装易语言 5.9 官方正式版<br>二、将易语言 5.92 版升级包里面的文件复制到安装目录<br>三、将易语言 5.92 破解补丁里面的“e.exe”复制到安装目录<br>四、可以选择安装易语言助手<br>五、如果出现静态连接失败，请使用“易语言静态连接失败智能修复器 v1.2.exe”进行修复</p>
<p>开钱箱源码</p>
<p>.版本 2<br>.支持库 eAPI</p>
<p>.程序集 程序集 1</p>
<p>.子程序 _启动子程序, 整数型, , 本子程序在程序启动后最先执行<br>.局部变量 hPrinter, 整数型<br>.局部变量 pd, PRINTER_DEFAULTS<br>.局部变量 字符串, 字节型, , “5”</p>
<p>字符串 ＝ { 27, 112, 0, 128, 128 } ‘ 打印机指令<br>OpenPrinter (取默认打印机 (), hPrinter, pd)<br>StartDocPrinterA (hPrinter, 1, pd)<br>StartPagePrinter (hPrinter)<br>WritePrinter (hPrinter, 字符串, 5, 0)<br>ClosePrinter (hPrinter)<br>‘ 调试输出 (OpenPrinter (取默认打印机 (), hPrinter, pd))<br>‘ 调试输出 (hPrinter)<br>‘ 调试输出 (StartDocPrinterA (hPrinter, 1, pd))<br>‘ 调试输出 (StartPagePrinter (hPrinter))<br>‘ 调试输出 (WritePrinter (hPrinter, 字符串, 5, 0))<br>‘ 调试输出 (ClosePrinter (hPrinter))<br>返回 (0) ‘ 可以根据您的需要返回任意数值</p>
<p>其他打印机开钱箱指令</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">Axionhm A715 <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">48</span>,<span class="number">251</span></span><br><span class="line">Axionhm A756 <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">48</span>,<span class="number">251</span></span><br><span class="line">Axionhm A794 <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">48</span>,<span class="number">251</span></span><br><span class="line">Bixolon SRP-<span class="number">275</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">48</span>,<span class="number">55</span>,<span class="number">121</span></span><br><span class="line">Epson All <span class="number">27</span>,<span class="number">121</span>,<span class="number">48</span>,<span class="number">55</span>,<span class="number">121</span></span><br><span class="line">Epson M51PD <span class="number">27</span>,<span class="number">112</span>,<span class="number">48</span>,<span class="number">55</span>,<span class="number">121</span></span><br><span class="line">Epson TM-T60 <span class="number">27</span>,<span class="number">112</span>,<span class="number">32</span>,<span class="number">25</span></span><br><span class="line">Epson TM-L60II <span class="number">27</span>,<span class="number">70</span>,<span class="number">0</span>,<span class="number">50</span>,<span class="number">50</span></span><br><span class="line">Epson TM-T70 <span class="number">27</span>,<span class="number">112</span>,<span class="number">48</span>,<span class="number">55</span>,<span class="number">121</span></span><br><span class="line">Epson T88iii <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U200D <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson T88iiiP <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">64</span>,<span class="number">240</span></span><br><span class="line">Epson TM-U200D <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">64</span>,<span class="number">240</span></span><br><span class="line">Epson TM-88IV <span class="number">27</span>,<span class="number">112</span>,<span class="number">48</span>,<span class="number">55</span>,<span class="number">121</span></span><br><span class="line">Epson TM-88V <span class="number">27</span>,<span class="number">112</span>,<span class="number">48</span>,<span class="number">55</span>,<span class="number">121</span></span><br><span class="line">Epson M188D <span class="number">27</span>,<span class="number">112</span>,<span class="number">48</span>,<span class="number">55</span>,<span class="number">121</span></span><br><span class="line">Epson M192C <span class="number">27</span>,<span class="number">112</span>,<span class="number">48</span>,<span class="number">55</span>,<span class="number">121</span></span><br><span class="line">Epson TM-U200 <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U200B <span class="number">27</span>,<span class="number">112</span>,<span class="number">48</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U200D <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">64</span>,<span class="number">240</span></span><br><span class="line">Epson TM-U210PD <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U210-D <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U220A <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U220PD <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U295 <span class="number">27</span>,<span class="number">112</span>,<span class="number">48</span>,<span class="number">55</span>,<span class="number">121</span></span><br><span class="line">Epson ADP-<span class="number">300</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-300D <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U950P <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U300PD <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U325D <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U375 <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson M665A <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">50</span>,<span class="number">250</span></span><br><span class="line">Epson TM-T883P <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">50</span>,<span class="number">250</span></span><br><span class="line">Epson TM-U950P <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">50</span>,<span class="number">250</span></span><br><span class="line">Epson TM-H500II <span class="number">27</span>,<span class="number">113</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Epson TM-H6000 <span class="number">27</span>,<span class="number">112</span>,<span class="number">48</span>,<span class="number">55</span>,<span class="number">121</span></span><br><span class="line">IBM <span class="number">4610</span> <span class="number">7</span></span><br><span class="line">IBM <span class="number">4611</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">50</span>,<span class="number">250</span></span><br><span class="line">Ithaca PcOS-<span class="number">51</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Ithaca PcOS-<span class="number">52</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Ithaca PcOSjet <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Ithaca <span class="number">80</span>-PLUS <span class="number">27</span>,<span class="number">120</span>,<span class="number">1</span></span><br><span class="line">Ithaca SERIES-<span class="number">90</span> <span class="number">27</span>,<span class="number">120</span>,<span class="number">1</span></span><br><span class="line">Ithaca <span class="number">150</span> <span class="number">27</span>,<span class="number">120</span>,<span class="number">1</span></span><br><span class="line">Ithaca POSjet-<span class="number">1000</span> <span class="number">27</span>,<span class="number">120</span>,<span class="number">1</span></span><br><span class="line">NCR <span class="number">7167</span> <span class="number">27</span>,<span class="number">120</span>,<span class="number">1</span></span><br><span class="line">Oliveti PRT-<span class="number">100</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Pos-X XR-<span class="number">200</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Pos-X XR-<span class="number">500</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Posiflex CR-<span class="number">4200</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">80</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Posiflex AURA-<span class="number">5600</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Posiflex PP6000 <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Posiflex PP7000 <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Samsung SRP-<span class="number">131</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">48</span>,<span class="number">50</span></span><br><span class="line">Samsung SRP-<span class="number">270</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Samsung SRP-270A <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">64</span>,<span class="number">240</span></span><br><span class="line">Samsung SRP-<span class="number">270</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">48</span>,<span class="number">55</span>,<span class="number">121</span></span><br><span class="line">Samsung SRP-<span class="number">350</span> <span class="number">27</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">25</span>,<span class="number">250</span></span><br><span class="line">Star All <span class="number">27</span>,<span class="number">7</span>,<span class="number">11</span>,<span class="number">55</span>,<span class="number">7</span></span><br><span class="line">Star TSP <span class="number">100</span> <span class="number">7</span></span><br><span class="line">Star SP212 <span class="number">27</span>,<span class="number">7</span>,<span class="number">11</span>,<span class="number">55</span>,<span class="number">7</span></span><br><span class="line">Star TSP200 <span class="number">27</span>,<span class="number">7</span>,<span class="number">11</span>,<span class="number">55</span>,<span class="number">7</span></span><br><span class="line">Star SP500 <span class="number">27</span>,<span class="number">122</span>,<span class="number">49</span>,<span class="number">7</span></span><br><span class="line">Star TSP-<span class="number">600</span> <span class="number">27</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">50</span>,<span class="number">7</span></span><br><span class="line">Star TSP-<span class="number">700</span> <span class="number">27</span>,<span class="number">07</span>,<span class="number">11</span>,<span class="number">55</span>,<span class="number">07</span></span><br><span class="line">Star SP2000 <span class="number">27</span>,<span class="number">122</span>,<span class="number">49</span>,<span class="number">7</span></span><br><span class="line">Tec RKP300 <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">100</span>,<span class="number">250</span></span><br><span class="line">Tec TRST-<span class="number">53</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">100</span>,<span class="number">250</span></span><br><span class="line">Toshiba SX2100 <span class="number">27</span>,<span class="number">112</span>,<span class="number">32</span>,<span class="number">55</span>,<span class="number">255</span></span><br><span class="line">Toshiba Tec-DRJST-<span class="number">51</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">100</span>,<span class="number">250</span></span><br><span class="line">Unisys EF4272 <span class="number">27</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">100</span>,<span class="number">250</span></span><br><span class="line">Wasp WTP-<span class="number">100</span> <span class="number">27</span>,<span class="number">112</span>,<span class="number">49</span>,<span class="number">48</span>,<span class="number">48</span></span><br></pre></td></tr></table></figure>

<h1 id="项目需求"><a href="#项目需求" class="headerlink" title="项目需求"></a>项目需求</h1><h2 id="裕创"><a href="#裕创" class="headerlink" title="裕创"></a>裕创</h2><p>字段</p>
<ol>
<li>会员表<code>member</code>增加门店 <code>store_ids</code> 关联</li>
<li>平台配置<code>platform_deploy</code><br>总部派送,不限制门店库存<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JavaScript</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// 门店缺货由总部派送（裕创280增加）</span></span><br><span class="line"> <span class="attr">head_office_delivery</span>: &#123; <span class="attr">type</span>: <span class="built_in">Boolean</span>, <span class="attr">default</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">  <span class="comment">// 门店会员访问权限（裕创280增加） 0 所有门店 1 仅限访问关联加盟店</span></span><br><span class="line">  <span class="attr">allow_stores</span>: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">default</span>: <span class="number">0</span> &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>门店表<code>store</code><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     <span class="comment">// 门店类型 0 自营店  1 加盟店</span></span><br><span class="line"> <span class="attr">store_type</span>: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">default</span>: <span class="number">0</span> &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>订单表 <code>order_library</code></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 商品列表</span></span><br><span class="line">  <span class="attr">product_list</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 调货门店erp内码</span></span><br><span class="line">      <span class="attr">erp_code</span>: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">default</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取品平台配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> platform_deploy = <span class="keyword">await</span> MAPP.db_getOne(&#123;</span><br><span class="line">  <span class="attr">model</span>: <span class="string">&#x27;platform_deploy&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>调用方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JavaScript</span></span><br><span class="line"><span class="keyword">const</span> &#123; headStoreGood &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../commodity/_methods&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> &#123; <span class="attr">stock</span>: _stock = <span class="number">0</span>, <span class="attr">store_id</span>: _store_id = <span class="string">&#x27;&#x27;</span> &#125; = <span class="keyword">await</span> headStoreGood(&#123; <span class="attr">goods_id</span>: product_id, store_id &#125;)</span><br><span class="line"><span class="comment">// 当前门店是总部</span></span><br><span class="line"><span class="keyword">if</span> (_store_id.toString() === store_id.toString()) &#123;</span><br><span class="line">  _stock = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">storeCommodity.stock = MAPP.plus(storeCommodity.stock, _stock)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>说明：<br>1、消费者如果只关联加盟店，且平台配置开启了【仅限访问关联加盟】（原【仅访问关联门店】），那么该消费者只能访问关联的加盟店，不可访问直营店和总店。<br>2、消费者如果关联了任意直营店，则可访问总店、其他任何直营店和已经关联的加盟店。<br>3、平台配置同时开启【仅限访问关联加盟】和【登录时选择配送方式】时，【登录时选择配送方式】的弹窗以消费是否关联了直营店为判断依据。<br>1）如果消费者仅关联加盟店，登录时弹窗不需要显示，且不限制可视门店距离，并直接进入已关联的最近加盟店。<br>2）如果消费者关联了任意直营店，登录时显示配送方式选择弹窗。<br>4、调货门店 erp 内码，指的是门店缺货由总部派送商品时，缺货门店的 erp 内码。</p>
<h1 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h1><h2 id="商品基础表"><a href="#商品基础表" class="headerlink" title="商品基础表"></a>商品基础表</h2><table>
<thead>
<tr>
<th align="center">同步字段</th>
<th align="center">数据表字段</th>
<th align="center">同步值</th>
<th align="center">数据值</th>
<th align="center">是否非空</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">B_SN</td>
<td align="center"></td>
<td align="center">1</td>
<td align="center"></td>
<td align="center">非空</td>
<td align="center">同步序号</td>
</tr>
<tr>
<td align="center">NAME</td>
<td align="center">name</td>
<td align="center">商品名称</td>
<td align="center">商品名称</td>
<td align="center">非空</td>
<td align="center">名称</td>
</tr>
<tr>
<td align="center">BAR_CODE</td>
<td align="center">bar_code</td>
<td align="center">100001</td>
<td align="center">100001</td>
<td align="center">非空</td>
<td align="center">条码</td>
</tr>
<tr>
<td align="center">CODING</td>
<td align="center">coding</td>
<td align="center">A00001</td>
<td align="center">A00001</td>
<td align="center">非空</td>
<td align="center">编码</td>
</tr>
<tr>
<td align="center">COMMON_NAME</td>
<td align="center">common_name</td>
<td align="center">通用名</td>
<td align="center">通用名</td>
<td align="center">非空</td>
<td align="center">通用名</td>
</tr>
<tr>
<td align="center">MNEMONIC_CODE</td>
<td align="center">mnemonic_code</td>
<td align="center">zjm</td>
<td align="center">zjm</td>
<td align="center">非空</td>
<td align="center">首字母</td>
</tr>
<tr>
<td align="center">PRESCRIPTION</td>
<td align="center">prescription</td>
<td align="center">处方药</td>
<td align="center">处方药</td>
<td align="center">可空</td>
<td align="center">处方药类型</td>
</tr>
<tr>
<td align="center">ORIGINAL_PRICE</td>
<td align="center">original_price</td>
<td align="center">3</td>
<td align="center">3</td>
<td align="center">非空</td>
<td align="center">商品原价</td>
</tr>
<tr>
<td align="center">CURRENT_PRICE</td>
<td align="center">current_price</td>
<td align="center">3</td>
<td align="center">3</td>
<td align="center">非空</td>
<td align="center">商品现价(线上)</td>
</tr>
<tr>
<td align="center">CURRENT_PRICE_OFFLINE</td>
<td align="center">current_price_offline</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">可空</td>
<td align="center">商品现价(线下)</td>
</tr>
<tr>
<td align="center">KEYWORD</td>
<td align="center">keyword</td>
<td align="center">西药,感冒药</td>
<td align="center">西药,感冒药</td>
<td align="center">可空</td>
<td align="center">关键字</td>
</tr>
<tr>
<td align="center">DRUG_TYPE</td>
<td align="center">drug_type</td>
<td align="center">西药</td>
<td align="center">2</td>
<td align="center">非空</td>
<td align="center">药品类型</td>
</tr>
<tr>
<td align="center">DOSAGE</td>
<td align="center">usage</td>
<td align="center">每日三次</td>
<td align="center">每日三次</td>
<td align="center">可空</td>
<td align="center">用法用量</td>
</tr>
<tr>
<td align="center">UNIT</td>
<td align="center">unit</td>
<td align="center">件</td>
<td align="center">件</td>
<td align="center">非空</td>
<td align="center">单位</td>
</tr>
<tr>
<td align="center">UNIT_NUM</td>
<td align="center">unit_num</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">非空</td>
<td align="center">单位数量</td>
</tr>
<tr>
<td align="center">WEIGHT</td>
<td align="center">weight</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">可空</td>
<td align="center">重量</td>
</tr>
<tr>
<td align="center">VOLUME</td>
<td align="center">volume</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">可空</td>
<td align="center">体积</td>
</tr>
<tr>
<td align="center">SPECIFICATION</td>
<td align="center">specification</td>
<td align="center">500g/盒</td>
<td align="center">500g/盒</td>
<td align="center">非空</td>
<td align="center">规格</td>
</tr>
<tr>
<td align="center">FORMULATION</td>
<td align="center">formulation</td>
<td align="center">肠溶片</td>
<td align="center">肠溶片</td>
<td align="center">可空</td>
<td align="center">剂型</td>
</tr>
<tr>
<td align="center">INGREDIENT</td>
<td align="center">ingredient</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">非空</td>
<td align="center">成分</td>
</tr>
<tr>
<td align="center">SHAPE</td>
<td align="center">shape</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">性状</td>
</tr>
<tr>
<td align="center">INDICATIONS</td>
<td align="center">indications</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">适应症</td>
</tr>
<tr>
<td align="center">OVERDOSE</td>
<td align="center">overdose</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">非空</td>
<td align="center">药物过量</td>
</tr>
<tr>
<td align="center">DRUG_EFFECT</td>
<td align="center">drug_effect</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">药物作用</td>
</tr>
<tr>
<td align="center">CLINICAL_GUIDELINES</td>
<td align="center">clinical_guidelines</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">临床应用指南</td>
</tr>
<tr>
<td align="center">MANUFACTURER</td>
<td align="center">manufacturer</td>
<td align="center">生产厂家</td>
<td align="center">生产厂家</td>
<td align="center">非空</td>
<td align="center">生产厂家</td>
</tr>
<tr>
<td align="center">PRODUCTION_ORIGIN</td>
<td align="center">production_origin</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">生产产地</td>
</tr>
<tr>
<td align="center">FOR_PEOPLE</td>
<td align="center">for_people</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">适用人群</td>
</tr>
<tr>
<td align="center">TABOO</td>
<td align="center">taboo</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">禁忌</td>
</tr>
<tr>
<td align="center">STORAGE_METHOD</td>
<td align="center">storage_method</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">贮藏方式</td>
</tr>
<tr>
<td align="center">INTRODUCTION</td>
<td align="center">introduction</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">商品简介</td>
</tr>
<tr>
<td align="center">INDICATION</td>
<td align="center">indication</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">功能主治</td>
</tr>
<tr>
<td align="center">PRECAUTIONS</td>
<td align="center">precautions</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">注意事项</td>
</tr>
<tr>
<td align="center">ADVERSE_REACTIONS</td>
<td align="center">adverse_reactions</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">不良反应</td>
</tr>
<tr>
<td align="center">MEDICINE_INTERACTIONS</td>
<td align="center">medicine_interactions</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">药物相互作用</td>
</tr>
<tr>
<td align="center">GMP_CERTIFICATION</td>
<td align="center">gmp_certification</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">GMP 认证</td>
</tr>
<tr>
<td align="center">APPROVAL_NUMBER</td>
<td align="center">approval_number</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">批准文号</td>
</tr>
<tr>
<td align="center">VALIDITY_PERIOD</td>
<td align="center">validity_period</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">有效期</td>
</tr>
<tr>
<td align="center">MEDICAL</td>
<td align="center">medical</td>
<td align="center">Y</td>
<td align="center">true</td>
<td align="center">非空</td>
<td align="center">是否医保</td>
</tr>
<tr>
<td align="center">THREE_CATEGORIES</td>
<td align="center">three_categories</td>
<td align="center">N</td>
<td align="center">false</td>
<td align="center">非空</td>
<td align="center">是否三类</td>
</tr>
<tr>
<td align="center">COLD_CHAIN</td>
<td align="center">cold_chain</td>
<td align="center">N</td>
<td align="center">false</td>
<td align="center">非空</td>
<td align="center">是否冷链</td>
</tr>
<tr>
<td align="center">OVERSEAS</td>
<td align="center">overseas</td>
<td align="center">N</td>
<td align="center">false</td>
<td align="center">非空</td>
<td align="center">是否境外</td>
</tr>
<tr>
<td align="center">TARIFF</td>
<td align="center">tariff</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">非空</td>
<td align="center">进口税率</td>
</tr>
<tr>
<td align="center">EPIDEMIC_SITUATION</td>
<td align="center">epidemic_situation</td>
<td align="center">N</td>
<td align="center">false</td>
<td align="center">非空</td>
<td align="center">是否疫情</td>
</tr>
<tr>
<td align="center">HIDE_GOODS</td>
<td align="center">hide_goods</td>
<td align="center">N</td>
<td align="center">false</td>
<td align="center">可空</td>
<td align="center">是否隐藏</td>
</tr>
<tr>
<td align="center">SORT</td>
<td align="center">sort</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">可空</td>
<td align="center">跨境排序</td>
</tr>
<tr>
<td align="center">NEAR_TERM_WARNING</td>
<td align="center">near_term_warning</td>
<td align="center">180</td>
<td align="center">180</td>
<td align="center">可空</td>
<td align="center">近效期预警天数</td>
</tr>
<tr>
<td align="center">LOCAL_CODE</td>
<td align="center">local_code</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">可空</td>
<td align="center">本位码</td>
</tr>
<tr>
<td align="center">INSERT_TIME</td>
<td align="center"></td>
<td align="center">YYYY-MM-DD HH:mm:ss</td>
<td align="center"></td>
<td align="center">非空</td>
<td align="center">插入时间</td>
</tr>
</tbody></table>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://wecy-chen.github.io">wecyChen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wecy-chen.github.io/2022/08/22/retail_core/">https://wecy-chen.github.io/2022/08/22/retail_core/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wecy-chen.github.io" target="_blank">欢迎,欢迎━(*｀∀´*)ノ亻!</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/xxx" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/22/ts/"><img class="prev-cover" src="https://img1.baidu.com/it/u=1212351743,2406672358&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=PNG?w=892&amp;h=500" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">TypeScript</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/22/git/"><img class="next-cover" src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20190801%2Fc96c28ceafbe42a8aa114324d2a31e58.jpeg&amp;refer=http%3A%2F%2F5b0988e595225.cdn.sohucs.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1656640110&amp;t=774a3f694864a9bd86ca43e203bfd4c3" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">git</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/27757669?s=400&amp;u=26d5a9ed7384d80a460ddb7961c1bd28f40e3aae&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">wecyChen</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/wecy-chen"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">这是一个简单的个人博客</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.</span> <span class="toc-text">接口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.1.</span> <span class="toc-text">查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0"><span class="toc-number">1.2.</span> <span class="toc-text">更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%9A%E5%90%88"><span class="toc-number">1.3.</span> <span class="toc-text">聚合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4"><span class="toc-number">1.4.</span> <span class="toc-text">删除</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">通用方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MAPP"><span class="toc-number">1.6.</span> <span class="toc-text">MAPP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.7.</span> <span class="toc-text">校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">1.8.</span> <span class="toc-text">缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.</span> <span class="toc-text">索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.10.</span> <span class="toc-text">事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.11.</span> <span class="toc-text">微信模板</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0"><span class="toc-number">2.</span> <span class="toc-text">后台</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E4%B8%AD%E5%BF%83"><span class="toc-number">3.</span> <span class="toc-text">消息中心</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#b2c"><span class="toc-number">4.</span> <span class="toc-text">b2c</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E5%95%86%E5%93%81"><span class="toc-number">4.1.</span> <span class="toc-text">推荐商品</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E9%94%80"><span class="toc-number">4.2.</span> <span class="toc-text">限销</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E5%95%86%E5%93%81%E6%90%9C%E7%B4%A2"><span class="toc-number">4.3.</span> <span class="toc-text">前台商品搜索</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E9%94%80"><span class="toc-number">5.</span> <span class="toc-text">分销</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8F%8D%E8%8D%AF%E4%BC%98%E9%80%89"><span class="toc-number">5.1.</span> <span class="toc-text">珍药优选</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E9%94%80%E4%BD%A3%E9%87%91"><span class="toc-number">5.2.</span> <span class="toc-text">分销佣金</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%A3%E9%87%91%E7%BB%93%E7%AE%97"><span class="toc-number">5.3.</span> <span class="toc-text">佣金结算</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%97%E5%91%98%E7%AB%AF"><span class="toc-number">6.</span> <span class="toc-text">店员端</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#webpos"><span class="toc-number">7.</span> <span class="toc-text">webpos</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%80%E6%AC%BE"><span class="toc-number">7.1.</span> <span class="toc-text">退款</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B6%E9%93%B6%E5%8F%B0"><span class="toc-number">7.2.</span> <span class="toc-text">收银台</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E5%93%81%E6%94%B9%E4%BB%B7"><span class="toc-number">7.3.</span> <span class="toc-text">单品改价</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%83%E9%94%80"><span class="toc-number">7.4.</span> <span class="toc-text">促销</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#webpos-1"><span class="toc-number">7.4.1.</span> <span class="toc-text">webpos</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%89%93%E5%8C%85"><span class="toc-number">7.5.</span> <span class="toc-text">配置打包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%86%E5%93%81"><span class="toc-number">7.6.</span> <span class="toc-text">商品</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BE"><span class="toc-number">7.7.</span> <span class="toc-text">高德地图</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%93%E5%AD%98"><span class="toc-number">8.</span> <span class="toc-text">库存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#webpos-%E9%94%80%E5%94%AE"><span class="toc-number">8.1.</span> <span class="toc-text">webpos 销售</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%93%E5%AD%98%E5%8D%95%E6%8D%AE"><span class="toc-number">8.2.</span> <span class="toc-text">库存单据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%98%E7%82%B9%E5%8D%95"><span class="toc-number">8.2.1.</span> <span class="toc-text">盘点单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E8%B4%A7%E5%8D%95"><span class="toc-number">8.2.2.</span> <span class="toc-text">请货单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BA%E5%BA%93%E5%8D%95"><span class="toc-number">8.2.3.</span> <span class="toc-text">出库单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%B7%E6%A0%BC"><span class="toc-number">9.</span> <span class="toc-text">价格</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%9A%E5%91%98%E4%BB%B7"><span class="toc-number">9.1.</span> <span class="toc-text">会员价</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#plus-%E4%BC%9A%E5%91%98%E4%BB%B7"><span class="toc-number">9.2.</span> <span class="toc-text">plus 会员价</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95"><span class="toc-number">10.</span> <span class="toc-text">订单</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%A2%E6%9C%8D"><span class="toc-number">11.</span> <span class="toc-text">客服</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6"><span class="toc-number">11.1.</span> <span class="toc-text">调度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%86%E5%93%81-1"><span class="toc-number">11.2.</span> <span class="toc-text">商品</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%93%E5%8D%B0"><span class="toc-number">12.</span> <span class="toc-text">打印</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4"><span class="toc-number">12.1.</span> <span class="toc-text">指令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%9C%80%E6%B1%82"><span class="toc-number">13.</span> <span class="toc-text">项目需求</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A3%95%E5%88%9B"><span class="toc-number">13.1.</span> <span class="toc-text">裕创</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5"><span class="toc-number">14.</span> <span class="toc-text">同步</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%86%E5%93%81%E5%9F%BA%E7%A1%80%E8%A1%A8"><span class="toc-number">14.1.</span> <span class="toc-text">商品基础表</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/17/yuntong/" title="运通项目"><img src="/img/default_top_img.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="运通项目"/></a><div class="content"><a class="title" href="/2023/06/17/yuntong/" title="运通项目">运通项目</a><time datetime="2023-06-17T08:00:00.000Z" title="发表于 2023-06-17 16:00:00">2023-06-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/11/essay/" title="随记"><img src="/img/default_top_img.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="随记"/></a><div class="content"><a class="title" href="/2023/02/11/essay/" title="随记">随记</a><time datetime="2023-02-11T05:51:16.465Z" title="发表于 2023-02-11 13:51:16">2023-02-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/08/promotion/" title="新零售促销说明"><img src="/xxx" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="新零售促销说明"/></a><div class="content"><a class="title" href="/2023/02/08/promotion/" title="新零售促销说明">新零售促销说明</a><time datetime="2023-02-08T05:50:41.756Z" title="发表于 2023-02-08 13:50:41">2023-02-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/18/wx/" title="无题"><img src="/img/default_top_img.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2022/10/18/wx/" title="无题">无题</a><time datetime="2022-10-18T07:20:48.094Z" title="发表于 2022-10-18 15:20:48">2022-10-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/26/macOS/" title="mac操作技巧"><img src="/img/default_top_img.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mac操作技巧"/></a><div class="content"><a class="title" href="/2022/09/26/macOS/" title="mac操作技巧">mac操作技巧</a><time datetime="2022-09-26T00:55:46.932Z" title="发表于 2022-09-26 08:55:46">2022-09-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By wecyChen</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>